
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>附录7-mha配置.md · MySQL搬砖</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="suredandan">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-prism/prism-solarizedlight.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="f_mysqlcheck.html" />
    

    
        <link rel="shortcut icon" href='favicon.ico' type="image/x-icon">
    
    
        <link rel="bookmark" href='favicon.ico' type="image/x-icon">
    
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                        <b>1.1.</b>
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="1.introduceandinstall.html">
            
                <a href="1.introduceandinstall.html">
            
                    
                        <b>1.2.</b>
                    
                    1.MySQL介绍与安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="2.connectandrole.html">
            
                <a href="2.connectandrole.html">
            
                    
                        <b>1.3.</b>
                    
                    2.MySQL的连接与权限
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="3.parameterintro.html">
            
                <a href="3.parameterintro.html">
            
                    
                        <b>1.4.</b>
                    
                    3.MySQL参数详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="4.jiagoujieshao.html">
            
                <a href="4.jiagoujieshao.html">
            
                    
                        <b>1.5.</b>
                    
                    4.MySQL体系介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="5.cuncunyinqin.html">
            
                <a href="5.cuncunyinqin.html">
            
                    
                        <b>1.6.</b>
                    
                    5.MySQL的存储引擎
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="6.duoshili.html">
            
                <a href="6.duoshili.html">
            
                    
                        <b>1.7.</b>
                    
                    6.MySQL多实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="7.aboutssl.html">
            
                <a href="7.aboutssl.html">
            
                    
                        <b>1.8.</b>
                    
                    7.MySQL的SSL相关
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="8.datatypeintro.html">
            
                <a href="8.datatypeintro.html">
            
                    
                        <b>1.9.</b>
                    
                    8.MySQL的数据类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="9.createtable.html">
            
                <a href="9.createtable.html">
            
                    
                        <b>1.10.</b>
                    
                    9.表的创建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="10.sqlselect.html">
            
                <a href="10.sqlselect.html">
            
                    
                        <b>1.11.</b>
                    
                    10.SQL之select
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="11.sqldml.html">
            
                <a href="11.sqldml.html">
            
                    
                        <b>1.12.</b>
                    
                    11.SQL之增删改
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="12.sqlextra.html">
            
                <a href="12.sqlextra.html">
            
                    
                        <b>1.13.</b>
                    
                    12.SQL其他补充
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="13.cfqandccgc.html">
            
                <a href="13.cfqandccgc.html">
            
                    
                        <b>1.14.</b>
                    
                    13.触发器存储过程函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="14.backrecover.html">
            
                <a href="14.backrecover.html">
            
                    
                        <b>1.15.</b>
                    
                    14.备份与恢复
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="15.backuprecoverpxb.html">
            
                <a href="15.backuprecoverpxb.html">
            
                    
                        <b>1.16.</b>
                    
                    15.备份恢复-pxb
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="16.basetest.html">
            
                <a href="16.basetest.html">
            
                    
                        <b>1.17.</b>
                    
                    16.基准测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="17.performancetest.html">
            
                <a href="17.performancetest.html">
            
                    
                        <b>1.18.</b>
                    
                    17.性能测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="18.replication.html">
            
                <a href="18.replication.html">
            
                    
                        <b>1.19.</b>
                    
                    18.主从复制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="19.haintro.html">
            
                <a href="19.haintro.html">
            
                    
                        <b>1.20.</b>
                    
                    19.高可用选型介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="20.performance.html">
            
                <a href="20.performance.html">
            
                    
                        <b>1.21.</b>
                    
                    20.优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.22" data-path="21.sqltunning.html">
            
                <a href="21.sqltunning.html">
            
                    
                        <b>1.22.</b>
                    
                    21.SQL优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.23" data-path="22.mysqlfaq.html">
            
                <a href="22.mysqlfaq.html">
            
                    
                        <b>1.23.</b>
                    
                    22.MySQL_FAQ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24" data-path="fulu.html">
            
                <a href="fulu.html">
            
                    
                        <b>1.24.</b>
                    
                    附录
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.24.1" data-path="f_lvsvsnginxvshaproxy.html">
            
                <a href="f_lvsvsnginxvshaproxy.html">
            
                    
                        <b>1.24.1.</b>
                    
                    附录1-三大软负载均衡器对比
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24.2" data-path="f_mysql5.7.html">
            
                <a href="f_mysql5.7.html">
            
                    
                        <b>1.24.2.</b>
                    
                    附录2-MySQL5.7新特性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24.3" data-path="f_sampleschema.html">
            
                <a href="f_sampleschema.html">
            
                    
                        <b>1.24.3.</b>
                    
                    附录3-MySQL的sample数据库安装部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24.4" data-path="f_youhuakuangjia.html">
            
                <a href="f_youhuakuangjia.html">
            
                    
                        <b>1.24.4.</b>
                    
                    附录4-MySQL优化框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24.5" data-path="f_usingprofile4sql.html">
            
                <a href="f_usingprofile4sql.html">
            
                    
                        <b>1.24.5.</b>
                    
                    附录5-使用profile分析sql
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24.6" data-path="f_mysqlcheck.html">
            
                <a href="f_mysqlcheck.html">
            
                    
                        <b>1.24.6.</b>
                    
                    附录6-mysqlcheck的使用
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.24.7" data-path="f_mha.html">
            
                <a href="f_mha.html">
            
                    
                        <b>1.24.7.</b>
                    
                    附录7-mha配置.md
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >附录7-mha配置.md</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <!-- toc -->
<ul>
<li><a href="#1-%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D">1. &#x73AF;&#x5883;&#x4ECB;&#x7ECD;</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4">2. &#x914D;&#x7F6E;&#x6B65;&#x9AA4;</a><ul>
<li><a href="#21%E9%85%8D%E7%BD%AE3%E5%8F%B0mysql%E6%9C%8D%E5%8A%A1%E5%99%A81%E4%B8%BB2%E4%BB%8E_%E5%9F%BA%E4%BA%8Egtid_">2.1.&#x914D;&#x7F6E;3&#x53F0;MySQL&#x670D;&#x52A1;&#x5668;1&#x4E3B;2&#x4ECE;(<em>&#x57FA;&#x4E8E;gtid</em>)</a><ul>
<li><a href="#211-%E5%9C%A8%E4%B8%BB%E5%BA%93%E4%B8%8A%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%88%B6%E7%94%A8%E6%88%B7%E5%92%8C%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7">2.1.1 &#x5728;&#x4E3B;&#x5E93;&#x4E0A;&#x521B;&#x5EFA;&#x590D;&#x5236;&#x7528;&#x6237;&#x548C;&#x7BA1;&#x7406;&#x7528;&#x6237;:</a></li>
<li><a href="#212-%E5%9C%A8%E4%B8%A4%E5%8F%B0%E4%BB%8E%E5%BA%93%E4%B8%8A%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">2.1.2 &#x5728;&#x4E24;&#x53F0;&#x4ECE;&#x5E93;&#x4E0A;&#x914D;&#x7F6E;&#x4E3B;&#x4ECE;&#x590D;&#x5236;</a></li>
</ul>
</li>
<li><a href="#22-%E5%AE%89%E8%A3%85%E7%9B%B8%E5%BA%94%E7%9A%84perl%E5%8C%85">2.2 &#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;perl&#x5305;</a><ul>
<li><a href="#221-%E5%9C%A8%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85mha4node">2.2.1 &#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4node</a></li>
<li><a href="#222-%E5%9C%A8%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85mha4manager">2.2.2 &#x5728;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4manager</a></li>
</ul>
</li>
<li><a href="#24-%E5%AF%B9%E4%BB%8E%E5%BA%93%E8%BF%9B%E8%A1%8C%E8%AE%BE%E7%BD%AE">2.4 &#x5BF9;&#x4ECE;&#x5E93;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;</a><ul>
<li><a href="#241-%E8%AE%BE%E7%BD%AE%E5%8F%AA%E8%AF%BB">2.4.1 &#x8BBE;&#x7F6E;&#x53EA;&#x8BFB;</a></li>
<li><a href="#242-relaylog%E7%9A%84%E6%B8%85%E7%90%86">2.4.2 relaylog&#x7684;&#x6E05;&#x7406;</a></li>
</ul>
</li>
<li><a href="#25-mha%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E7%9A%84%E9%85%8D%E7%BD%AE">2.5 mha&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x7684;&#x914D;&#x7F6E;</a><ul>
<li><a href="#251-%E8%8A%82%E7%82%B9%E7%9A%84%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC%E9%85%8D%E7%BD%AE">2.5.1 &#x8282;&#x70B9;&#x7684;&#x76F8;&#x5173;&#x811A;&#x672C;&#x914D;&#x7F6E;</a></li>
<li><a href="#252-failover%E8%84%9A%E6%9C%AC%E7%9A%84%E8%AE%BE%E7%BD%AE">2.5.2 failover&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;</a></li>
<li><a href="#253-sendmail%E8%84%9A%E6%9C%AC%E7%9A%84%E8%AE%BE%E7%BD%AE">2.5.3 sendmail&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;</a></li>
<li><a href="#254-mha%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC">2.5.4 mha&#x542F;&#x52A8;&#x811A;&#x672C;</a></li>
</ul>
</li>
<li><a href="#26-%E4%BA%92%E9%80%9A%E6%80%A7%E5%92%8C%E5%A4%8D%E5%88%B6%E7%9A%84%E9%AA%8C%E8%AF%81">2.6 &#x4E92;&#x901A;&#x6027;&#x548C;&#x590D;&#x5236;&#x7684;&#x9A8C;&#x8BC1;</a><ul>
<li><a href="#261-%E4%BA%92%E9%80%9A%E6%80%A7%E7%9A%84%E9%AA%8C%E8%AF%81">2.6.1 &#x4E92;&#x901A;&#x6027;&#x7684;&#x9A8C;&#x8BC1;</a></li>
<li><a href="#262-%E5%A4%8D%E5%88%B6%E6%AD%A3%E7%A1%AE%E6%80%A7%E7%9A%84%E9%AA%8C%E8%AF%81">2.6.2 &#x590D;&#x5236;&#x6B63;&#x786E;&#x6027;&#x7684;&#x9A8C;&#x8BC1;</a></li>
</ul>
</li>
<li><a href="#27-%E5%90%AF%E5%8A%A8manager%E8%8A%82%E7%82%B9">2.7 &#x542F;&#x52A8;manager&#x8282;&#x70B9;&#xFF1A;</a></li>
<li><a href="#28-%E6%A3%80%E6%9F%A5mha-manager%E7%9A%84%E7%8A%B6%E6%80%81">2.8 &#x68C0;&#x67E5;mha manager&#x7684;&#x72B6;&#x6001;&#xFF1A;</a></li>
<li><a href="#29-%E9%85%8D%E7%BD%AEvip%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9Fip%E5%9C%B0%E5%9D%80">2.9 &#x914D;&#x7F6E;VIP,&#x6DFB;&#x52A0;&#x865A;&#x62DF;Ip&#x5730;&#x5740;</a></li>
</ul>
</li>
<li><a href="#3-%E9%AA%8C%E8%AF%81%E5%88%87%E6%8D%A2%E9%AA%8C%E8%AF%81">3. &#x9A8C;&#x8BC1;&#x5207;&#x6362;&#x9A8C;&#x8BC1;</a></li>
<li><a href="#4%E8%8A%82%E7%82%B9%E9%87%8D%E6%96%B0%E4%B8%8A%E4%B8%8B%E6%AD%A5%E9%AA%A4">4.&#x8282;&#x70B9;&#x91CD;&#x65B0;&#x4E0A;&#x4E0B;&#x6B65;&#x9AA4;</a></li>
<li><a href="#5%E5%85%B6%E4%BB%96">5.&#x5176;&#x4ED6;</a></li>
</ul>
<!-- tocstop -->
<hr>
<h1 id="1-&#x73AF;&#x5883;&#x4ECB;&#x7ECD;">1. &#x73AF;&#x5883;&#x4ECB;&#x7ECD;</h1>
<table>
<thead>
<tr>
<th>ip&#x5730;&#x5740;</th>
<th>&#x4E3B;&#x673A;&#x540D;</th>
<th>&#x89D2;&#x8272;</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.175</td>
<td>nazeebo</td>
<td>master</td>
</tr>
<tr>
<td>192.168.0.176</td>
<td>lowa</td>
<td>slave</td>
</tr>
<tr>
<td>192.168.0.200</td>
<td>ai2018</td>
<td>slave + manager</td>
</tr>
</tbody>
</table>
<pre class="language-"><code>shell&gt; cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
192.168.0.175 nazeebo
192.168.0.176 lowa
192.168.0.200 ai2018
</code></pre><h1 id="2-&#x914D;&#x7F6E;&#x6B65;&#x9AA4;">2. &#x914D;&#x7F6E;&#x6B65;&#x9AA4;</h1>
<ul>
<li>&#x914D;&#x7F6E;3&#x53F0;MySQL&#x670D;&#x52A1;&#x5668;1&#x4E3B;2&#x4ECE;(<em>&#x57FA;&#x4E8E;gtid</em>)</li>
<li>&#x5728;&#x6570;&#x636E;&#x8282;&#x70B9;&#x548C;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684; mha &#x8F6F;&#x4EF6;&#x5305;</li>
<li>&#x5B89;&#x88C5;mha manager</li>
<li>&#x914D;&#x7F6E;ssh&#x7684;&#x4E92;&#x901A;</li>
<li>&#x5BF9;&#x4ECE;&#x5E93;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;:&#x53EA;&#x8BFB;,relaylog&#x6E05;&#x7406;</li>
<li>&#x5728;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x914D;&#x7F6E; mha &#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x548C;&#x811A;&#x672C;</li>
<li>&#x6DFB;&#x52A0;&#x865A;&#x62DF;IP</li>
</ul>
<h2 id="21&#x914D;&#x7F6E;3&#x53F0;mysql&#x670D;&#x52A1;&#x5668;1&#x4E3B;2&#x4ECE;&#x57FA;&#x4E8E;gtid">2.1.&#x914D;&#x7F6E;3&#x53F0;MySQL&#x670D;&#x52A1;&#x5668;1&#x4E3B;2&#x4ECE;(<em>&#x57FA;&#x4E8E;gtid</em>)</h2>
<h3 id="211-&#x5728;&#x4E3B;&#x5E93;&#x4E0A;&#x521B;&#x5EFA;&#x590D;&#x5236;&#x7528;&#x6237;&#x548C;&#x7BA1;&#x7406;&#x7528;&#x6237;">2.1.1 &#x5728;&#x4E3B;&#x5E93;&#x4E0A;&#x521B;&#x5EFA;&#x590D;&#x5236;&#x7528;&#x6237;&#x548C;&#x7BA1;&#x7406;&#x7528;&#x6237;:</h3>
<p>&#x521B;&#x5EFA;&#x590D;&#x5236;&#x7528;&#x6237;&#x5E76;&#x6388;&#x6743;</p>
<pre class="language-"><code>SQL&gt; GRANT REPLICATION SLAVE ON *.* TO repluser@192.168.0.176 IDENTIFIED BY  &apos;Oracle123&apos;;
SQL&gt; GRANT REPLICATION SLAVE ON *.* TO repluser@192.168.0.200 IDENTIFIED BY  &apos;Oracle123&apos;;
SQL&gt; flush privileges;
</code></pre><p>&#x521B;&#x5EFA;&#x7BA1;&#x7406;&#x7528;&#x6237;&#x5E76;&#x6388;&#x6743;</p>
<pre class="language-"><code>SQL&gt; grant all privileges on *.* to &apos;mhamon&apos;@&apos;192.168.0.200&apos; identified  by &apos;Oracle123&apos;;
SQL&gt; flush privileges;
</code></pre><h3 id="212-&#x5728;&#x4E24;&#x53F0;&#x4ECE;&#x5E93;&#x4E0A;&#x914D;&#x7F6E;&#x4E3B;&#x4ECE;&#x590D;&#x5236;">2.1.2 &#x5728;&#x4E24;&#x53F0;&#x4ECE;&#x5E93;&#x4E0A;&#x914D;&#x7F6E;&#x4E3B;&#x4ECE;&#x590D;&#x5236;</h3>
<pre class="language-"><code>SQL&gt; CHANGE MASTER TO MASTER_HOST=&apos;192.168.0.175&apos;,
MASTER_USER=&apos;repluser&apos;,
MASTER_PASSWORD=&apos;Oracle123&apos;,
MASTER_AUTO_POSITION=1;
</code></pre><h2 id="22-&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;perl&#x5305;">2.2 &#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;perl&#x5305;</h2>
<h3 id="221-&#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4node">2.2.1 &#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4node</h3>
<pre class="language-"><code>[root@lowa mha4mysql-0.57]# cd mha4mysql-node-0.57
[root@lowa mha4mysql-node-0.57]# ls
AUTHORS  bin  COPYING  debian  inc  lib  Makefile.PL  MANIFEST  META.yml  README  rpm  t
[root@lowa mha4mysql-node-0.57]# perl Makefile.PL
*** Module::AutoInstall version 1.06
*** Checking for Perl dependencies...
[Core Features]
- DBI        ...loaded. (1.609)
- DBD::mysql ...loaded. (4.013)
*** Module::AutoInstall configuration finished.
Checking if your kit is complete...
Looks good
Writing Makefile for mha4mysql::node
[root@lowa mha4mysql-node-0.57]# make &amp;&amp; make install
...
&#x8FD9;&#x4E2A;&#x5B89;&#x88C5;&#x5F88;&#x7B80;&#x5355;,&#x57FA;&#x672C;&#x4E0D;&#x4F1A;&#x6709;&#x95EE;&#x9898;
</code></pre><blockquote>
<p> Node&#x5DE5;&#x5177;&#x5305;&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x5DE5;&#x5177;&#xFF1A;</p>
<ul>
<li>save_binary_logs                &#x4FDD;&#x5B58;&#x548C;&#x590D;&#x5236;master&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x65E5;&#x5FD7;</li>
<li>apply_diff_relay_logs            &#x8BC6;&#x522B;&#x5DEE;&#x5F02;&#x7684;&#x4E2D;&#x7EE7;&#x65E5;&#x5FD7;&#x4E8B;&#x4EF6;&#x5E76;&#x5C06;&#x5176;&#x5DEE;&#x5F02;&#x7684;&#x4E8B;&#x4EF6;&#x5E94;&#x7528;&#x4E8E;&#x5176;&#x4ED6;&#x7684;slave</li>
<li>filter_mysqlbinlog               &#x53BB;&#x9664;&#x4E0D;&#x5FC5;&#x8981;&#x7684;ROLLBACK&#x4E8B;&#x4EF6;&#xFF08;MHA&#x5DF2;&#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x5DE5;&#x5177;&#xFF09;</li>
<li>purge_relay_logs                &#x6E05;&#x9664;&#x4E2D;&#x7EE7;&#x65E5;&#x5FD7;&#xFF08;&#x4E0D;&#x4F1A;&#x963B;&#x585E;SQL&#x7EBF;&#x7A0B;&#xFF09;
-</li>
</ul>
</blockquote>
<h3 id="222-&#x5728;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4manager">2.2.2 &#x5728;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x5B89;&#x88C5;mha4manager</h3>
<p>&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;perl&#x5305;</p>
<pre class="language-"><code>[root@ai2018 mha4mysql-manager-0.57]# perl -MDBD::mysql -e &quot;print\&quot;module installed\n\&quot;&quot;
module installed
[root@ai2018 mha4mysql-manager-0.57]# perl -Config::Tiny -e &quot;print\&quot;module installed\n\&quot;&quot;
Unknown Unicode option letter &apos;n&apos;.
[root@ai2018 mha4mysql-manager-0.57]# ls
AUTHORS  bin  blib  COPYING  debian  inc  lib  Makefile  Makefile.PL  MANIFEST  META.yml  README  rpm  samples  t  tests
[root@ai2018 mha4mysql-manager-0.57]# perl Makefile.PL
*** Module::AutoInstall version 1.06
*** Checking for Perl dependencies...
[Core Features]
- DBI                   ...loaded. (1.609)
- DBD::mysql            ...loaded. (4.013)
- Time::HiRes           ...loaded. (1.9721)
- Config::Tiny          ...missing.
- Log::Dispatch         ...missing.
- Parallel::ForkManager ...loaded. (0.7.9)
- MHA::NodeConst        ...loaded. (0.57)
==&gt; Auto-install the 2 mandatory module(s) from CPAN? [y] y
*** Dependencies will be installed the next time you type &apos;make&apos;.
*** Module::AutoInstall configuration finished.
Warning: prerequisite Config::Tiny 0 not found.
Warning: prerequisite Log::Dispatch 0 not found.
Writing Makefile for mha4mysql::manager
</code></pre><p>&#x8FD9;&#x513F;&#x9047;&#x5230;&#x4E86;&#x4E00;&#x4E9B;&#x95EE;&#x9898;,manager&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E00;&#x4E9B;perl&#x7684;&#x5305;&#x3002;&#x5148;&#x662F;&#x91C7;&#x7528;yum&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;perl&#x76F8;&#x5173;&#x5305;&#x7684;&#x5B89;&#x88C5;,&#x7ED3;&#x679C;&#x4E0D;&#x884C;,&#x540E;&#x6765;&#x53C8;&#x628A;rpm&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#x5B89;&#x88C5;,&#x4E5F;&#x4E0D;&#x884C;..</p>
<pre class="language-"><code>yum install -y perl-DBD-MySQL.x86_64 \
                     perl-DBI.x86_64 perl-ExtUtils-CBuilder \
                     perl-ExtUtils-MakeMaker perl-CPAN.x86_64 \
                     perl-Mail-Sender perl-Log-Dispatch
</code></pre><p>&#x6700;&#x540E;&#x800D;&#x4E86;&#x4E2A;&#x8D56;,&#x91C7;&#x7528;cpanm&#x6765;&#x8FDB;&#x884C;&#x5B89;&#x88C5;.</p>
<p>&#x5B89;&#x88C5;mha4manager</p>
<pre class="language-"><code>[root@ai2018 mha4mysql-manager-0.57]# pwd
/softdb/mha4mysql-0.57/mha4mysql-manager-0.57
[root@ai2018 mha4mysql-manager-0.57]# ls
AUTHORS  bin  blib  COPYING  debian  inc  lib  Makefile  Makefile.PL  MANIFEST  META.yml  README  rpm  samples  t  tests
[root@ai2018 mha4mysql-manager-0.57]# perl Makefile.PL
*** Module::AutoInstall version 1.06
*** Checking for Perl dependencies...
[Core Features]
- DBI                   ...loaded. (1.609)
- DBD::mysql            ...loaded. (4.013)
- Time::HiRes           ...loaded. (1.9721)
- Config::Tiny          ...loaded. (2.23)
- Log::Dispatch         ...loaded. (2.67)
- Parallel::ForkManager ...loaded. (0.7.9)
- MHA::NodeConst        ...loaded. (0.57)
*** Module::AutoInstall configuration finished.
Generating a Unix-style Makefile
Writing Makefile for mha4mysql::manager
Writing MYMETA.yml and MYMETA.json
[root@ai2018 mha4mysql-manager-0.57]# make &amp;&amp; make install
...
...
Appending installation info to /usr/lib64/perl5/perllocal.pod
</code></pre><blockquote>
<p>manager&#x5DE5;&#x5177;&#x5305;&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x5DE5;&#x5177;&#xFF1A;</p>
<ul>
<li>masterha_check_ssh              &#x68C0;&#x67E5;MHA&#x7684;SSH&#x914D;&#x7F6E;&#x72B6;&#x51B5;</li>
<li>masterha_check_repl             &#x68C0;&#x67E5;MySQL&#x590D;&#x5236;&#x72B6;&#x51B5;</li>
<li>masterha_manger                  &#x542F;&#x52A8;MHA</li>
<li>masterha_check_status            &#x68C0;&#x6D4B;&#x5F53;&#x524D;MHA&#x8FD0;&#x884C;&#x72B6;&#x6001;</li>
<li>masterha_master_monitor          &#x68C0;&#x6D4B;master&#x662F;&#x5426;&#x5B95;&#x673A;</li>
<li>masterha_master_switch           &#x63A7;&#x5236;&#x6545;&#x969C;&#x8F6C;&#x79FB;&#xFF08;&#x81EA;&#x52A8;&#x6216;&#x8005;&#x624B;&#x52A8;&#xFF09;</li>
<li>masterha_conf_host               &#x6DFB;&#x52A0;&#x6216;&#x5220;&#x9664;&#x914D;&#x7F6E;&#x7684;server&#x4FE1;&#x606F;</li>
</ul>
</blockquote>
<h4 id="23-&#x914D;&#x7F6E;ssh&#x4E92;&#x901A;">2.3 &#x914D;&#x7F6E;ssh&#x4E92;&#x901A;</h4>
<p>&#x91C7;&#x7528;ssh-copy-id&#x662F;&#x6700;&#x65B9;&#x4FBF;&#x7684;&#x624B;&#x6BB5;,&#x5982;&#x679C;OS&#x4E0A;&#x9762;&#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;,&#x53EF;&#x4EE5;&#x5148;&#x7528;
<code>yum install openssl/openssl-client</code> &#x6765;&#x8FDB;&#x884C;&#x5B89;&#x88C5;</p>
<pre class="language-"><code>shell&gt; ssh-keygen
shell&gt; ssh-copy-id  -i  /root/.ssh/id_rsa.pub  &quot;-p 10022  root@192.168.0.175&quot;
shell&gt; ssh-copy-id  -i  /root/.ssh/id_rsa.pub  &quot;-p 10022  root@192.168.0.176&quot;
shell&gt; ssh-copy-id  -i  /root/.ssh/id_rsa.pub  &quot;-p 10022  root@192.168.0.200&quot;
</code></pre><pre class="language-"><code>&#x6216;&#x8005;&#x4FEE;&#x6539;&#x5168;&#x5C40;&#x7684;
vim /etc/ssh/ssh_config
Port 10022
</code></pre><h2 id="24-&#x5BF9;&#x4ECE;&#x5E93;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;">2.4 &#x5BF9;&#x4ECE;&#x5E93;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;</h2>
<h3 id="241-&#x8BBE;&#x7F6E;&#x53EA;&#x8BFB;">2.4.1 &#x8BBE;&#x7F6E;&#x53EA;&#x8BFB;</h3>
<p>&#x5C06;&#x4E24;&#x53F0;slave&#x670D;&#x52A1;&#x5668;&#x8BBE;&#x7F6E;read_only
<kbd>&#x4ECE;&#x5E93;&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x8BFB;&#x670D;&#x52A1;&#xFF0C;&#x53EA;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x5199;&#x8FDB;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x968F;&#x65F6;slave&#x4F1A;&#x63D0;&#x5347;&#x4E3A;master </kbd></p>
<pre class="language-"><code>&#x5728;&#x4E24;&#x4E2A;&#x4ECE;&#x5E93;&#x4E0A;&#x6267;&#x884C;
shell&gt; mysql -uroot -p -e &apos;set global read_only=1&apos;
</code></pre><h3 id="242-relaylog&#x7684;&#x6E05;&#x7406;">2.4.2 relaylog&#x7684;&#x6E05;&#x7406;</h3>
<p>mha&#x5728;&#x53D1;&#x751F;&#x5207;&#x6362;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4ECE;&#x5E93;&#x7684;&#x6062;&#x590D;&#x8FC7;&#x7A0B;&#x4F1A;&#x4F9D;&#x8D56;&#x4E8E;relay log&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x8981;&#x5C06;relay log&#x7684;&#x81EA;&#x52A8;&#x6E05;&#x9664;&#x8BBE;&#x7F6E;&#x4E3A;OFF&#x3002;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x4E2D;&#x7EE7;&#x65E5;&#x5FD7;&#x4F1A;&#x5728;SQL&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;&#x88AB;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x3002;</p>
<pre class="language-"><code>&#x5728;&#x4E24;&#x4E2A;&#x4ECE;&#x5E93;&#x4E0A;&#x6267;&#x884C;
shell&gt; mysql -uroot -p -e &apos;set global relay_log_purge=0&apos;
</code></pre><h2 id="25-mha&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x7684;&#x914D;&#x7F6E;">2.5 mha&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x7684;&#x914D;&#x7F6E;</h2>
<p>&#x5148;&#x6765;&#x4E2A;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</p>
<pre class="language-"><code>[root@ai2018 mha]# tree /etc/mha
/etc/mha
&#x251C;&#x2500;&#x2500; app1
&#x2502;   &#x251C;&#x2500;&#x2500; app1.cnf
&#x2502;   &#x251C;&#x2500;&#x2500; app1.log #manager&#x7684;&#x65E5;&#x5FD7;
&#x2502;   &#x251C;&#x2500;&#x2500; app1.master_status.health #master&#x7684;&#x5065;&#x5EB7;&#x68C0;&#x67E5;&#x72B6;&#x6001;&#x65E5;&#x5FD7;
&#x2502;   &#x2514;&#x2500;&#x2500; app2.cnf #&#x5907;&#x4EFD;&#x7684;app1.cnf
&#x251C;&#x2500;&#x2500; bin
&#x2502;   &#x2514;&#x2500;&#x2500; mhaCli.sh  #mha&#x542F;&#x52A8;&#x811A;&#x672C;
&#x2514;&#x2500;&#x2500; script
    &#x251C;&#x2500;&#x2500; master_ip_failover #&#x81EA;&#x52A8;&#x5207;&#x6362;&#x7684;&#x811A;&#x672C;
    &#x2514;&#x2500;&#x2500; sendEmail  #&#x53D1;&#x9001;&#x90AE;&#x4EF6;&#x7684;&#x811A;&#x672C;,&#x5728;&#x8FD9;&#x513F;&#x6CA1;&#x6709;&#x9700;&#x6C42;,&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x914D;&#x7F6E;

3 directories, 7 files
</code></pre><h3 id="251-&#x8282;&#x70B9;&#x7684;&#x76F8;&#x5173;&#x811A;&#x672C;&#x914D;&#x7F6E;">2.5.1 &#x8282;&#x70B9;&#x7684;&#x76F8;&#x5173;&#x811A;&#x672C;&#x914D;&#x7F6E;</h3>
<p>app1.cnf</p>
<pre class="language-"><code>[server default]
manager_log=/etc/mha/app1/app1.log    # &#x8BBE;&#x7F6E;manager&#x7684;&#x65E5;&#x5FD7;
manager_workdir=/etc/mha/app1/      # &#x8BBE;&#x7F6E;manager&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;
master_binlog_dir=/u01/mysql/mysql_data     # &#x8BBE;&#x7F6E;master &#x4FDD;&#x5B58;binlog&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4EE5;&#x4FBF;MHA&#x53EF;&#x4EE5;&#x627E;&#x5230;master&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x662F;mysql&#x7684;&#x6570;&#x636E;&#x76EE;&#x5F55;
master_ip_failover_script=/etc/mha/script/master_ip_failover  # &#x8BBE;&#x7F6E;&#x81EA;&#x52A8;failover&#x65F6;&#x5019;&#x7684;&#x5207;&#x6362;&#x811A;&#x672C;
master_ip_online_change_script=/etc/mha/script/master_ip_failover  #&#x8BBE;&#x7F6E;&#x624B;&#x52A8;failover&#x65F6;&#x5019;&#x7684;&#x5207;&#x6362;&#x811A;&#x672C;
report_script=/etc/mha/script/sendEmail    # &#x8BBE;&#x7F6E;&#x53D1;&#x751F;&#x5207;&#x6362;&#x540E;&#x53D1;&#x9001;&#x7684;&#x62A5;&#x8B66;&#x7684;&#x811A;&#x672C;
remote_workdir=/tmp    # &#x8BBE;&#x7F6E;&#x8FDC;&#x7AEF;mysql&#x5728;&#x53D1;&#x751F;&#x5207;&#x6362;&#x65F6;binlog&#x7684;&#x4FDD;&#x5B58;&#x4F4D;&#x7F6E;
ping_interval=3        #&#x8BBE;&#x7F6E;&#x76D1;&#x63A7;&#x4E3B;&#x5E93;&#xFF0C;&#x53D1;&#x9001;ping&#x5305;&#x7684;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;3&#x79D2;&#xFF0C;&#x5C1D;&#x8BD5;&#x4E09;&#x6B21;&#x6CA1;&#x6709;&#x56DE;&#x5E94;&#x7684;&#x65F6;&#x5019;&#x81EA;&#x52A8;&#x8FDB;&#x884C;railover

user=mhamon     # &#x8BBE;&#x7F6E;&#x76D1;&#x63A7;&#x7528;&#x6237;
password=Oracle123    #  &#x8BBE;&#x7F6E;&#x76D1;&#x63A7;&#x7528;&#x6237;&#x7684;&#x5BC6;&#x7801;

repl_user=repluser        # &#x8BBE;&#x7F6E;&#x590D;&#x5236;&#x8D26;&#x53F7;
repl_password=Oracle123    # &#x8BBE;&#x7F6E;&#x590D;&#x5236;&#x8D26;&#x53F7;&#x7684;&#x5BC6;&#x7801;

ssh_user=root      # &#x8BBE;&#x7F6E;ssh&#x7684;&#x767B;&#x9646;&#x7528;&#x6237;
ssh_port=10022           # &#x8BBE;&#x7F6E;ssh&#x7684;&#x7AEF;&#x53E3;&#x53F7;


secondary_check_script=/usr/local/bin/masterha_secondary_check -s slave87 -s slave88

[server1]
hostname=192.168.0.175
port=3306
master_binlog_dir=/u01/mysql/mysql_data

[server2]
hostname=192.168.0.176
port=3306
master_binlog_dir=/u01/mysql/mysql_data


[server3]
hostname=192.168.0.200
port=3306
master_binlog_dir=/u01/mysql/mysql_data
</code></pre><h3 id="252-failover&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;">2.5.2 failover&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;</h3>
<pre class="language-"><code>#!/usr/bin/env perl

use strict;
use warnings FATAL =&gt; &apos;all&apos;;

use Getopt::Long;

my (
    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,
    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port
);

my $vip = &apos;192.168.0.177/24&apos;;   # &#x8BBE;&#x7F6E;VIP
my $key = &apos;88&apos;;             # &#x6B64;&#x5904;&#x4EE3;&#x8868; &#x7ED1;&#x5B9A;&#x5728; eth2:88&#x4E0A;
my $ssh_start_vip = &quot;/sbin/ifconfig eth2:$key $vip&quot;;  # &#x5F00;&#x542F;VIP
my $ssh_stop_vip = &quot;/sbin/ifconfig eth2:$key down&quot;;  # &#x5173;&#x95ED;VIP

GetOptions(
    &apos;command=s&apos;          =&gt; \$command,
    &apos;ssh_user=s&apos;         =&gt; \$ssh_user,
    &apos;orig_master_host=s&apos; =&gt; \$orig_master_host,
    &apos;orig_master_ip=s&apos;   =&gt; \$orig_master_ip,
    &apos;orig_master_port=i&apos; =&gt; \$orig_master_port,
    &apos;new_master_host=s&apos;  =&gt; \$new_master_host,
    &apos;new_master_ip=s&apos;    =&gt; \$new_master_ip,
    &apos;new_master_port=i&apos;  =&gt; \$new_master_port,
);

exit &amp;main();

sub main {

    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;

    if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) {

        my $exit_code = 1;
        eval {
            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;
            &amp;stop_vip();
            $exit_code = 0;
        };
        if ($@) {
            warn &quot;Got Error: $@\n&quot;;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq &quot;start&quot; ) {

        my $exit_code = 10;
        eval {
            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;
            &amp;start_vip();
            $exit_code = 0;
        };
        if ($@) {
            warn $@;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq &quot;status&quot; ) {
        print &quot;Checking the Status of the script.. OK \n&quot;;
        exit 0;
    }
    else {
        &amp;usage();
        exit 1;
    }
}

sub start_vip() {
    `ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;
}
sub stop_vip() {
     return 0  unless  ($ssh_user);
    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;
}

sub usage {
    print
    &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_i
p=ip --new_master_port=port\n&quot;;
}
</code></pre><h3 id="253-sendmail&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;">2.5.3 sendmail&#x811A;&#x672C;&#x7684;&#x8BBE;&#x7F6E;</h3>
<p>&#x6CA1;&#x6709;&#x9700;&#x6C42;,&#x627E;&#x4E86;&#x4E2A;sample&#x4F5C;&#x4E3A;&#x53C2;&#x8003;</p>
<pre class="language-"><code>#!/usr/bin/perl

#  Copyright (C) 2011 DeNA Co.,Ltd.
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#  Foundation, Inc.,
#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

## Note: This is a sample script and is not complete. Modify the script based on your environment.

use strict;
use warnings FATAL =&gt; &apos;all&apos;;
use Mail::Sender;
use Getopt::Long;

#new_master_host and new_slave_hosts are set only when recovering master succeeded
my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );
my $smtp=&apos;smtp.163.com&apos;;
my $mail_from=&apos;xxx@163.com&apos;;
my $mail_user=&apos;xxx@163.com&apos;;
my $mail_pass=&apos;xxxxxx&apos;;
my $mail_to=[&apos;xxx@xxx.cn&apos;,&apos;xxxxx@xxx.cn&apos;];
GetOptions(
  &apos;orig_master_host=s&apos; =&gt; \$dead_master_host,
  &apos;new_master_host=s&apos;  =&gt; \$new_master_host,
  &apos;new_slave_hosts=s&apos;  =&gt; \$new_slave_hosts,
  &apos;subject=s&apos;          =&gt; \$subject,
  &apos;body=s&apos;             =&gt; \$body,
);

mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);

sub mailToContacts {
    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;
    open my $DEBUG, &quot;&gt; /tmp/monitormail.log&quot;
        or die &quot;Can&apos;t open the debug      file:$!\n&quot;;
    my $sender = new Mail::Sender {
        ctype       =&gt; &apos;text/plain; charset=utf-8&apos;,
        encoding    =&gt; &apos;utf-8&apos;,
        smtp        =&gt; $smtp,
        from        =&gt; $mail_from,
        auth        =&gt; &apos;LOGIN&apos;,
        TLS_allowed =&gt; &apos;0&apos;,
        authid      =&gt; $user,
        authpwd     =&gt; $passwd,
        to          =&gt; $mail_to,
        subject     =&gt; $subject,
        debug       =&gt; $DEBUG
    };

    $sender-&gt;MailMsg(
        {   msg   =&gt; $msg,
            debug =&gt; $DEBUG
        }
    ) or print $Mail::Sender::Error;
    return 1;
}



# Do whatever you want here

exit 0;
</code></pre><h3 id="254-mha&#x542F;&#x52A8;&#x811A;&#x672C;">2.5.4 mha&#x542F;&#x52A8;&#x811A;&#x672C;</h3>
<pre class="language-"><code># cat bin/mhaCli.sh
#!/bin/bash

. /etc/profile
. ~/.bash_profile
. ~/.bashrc

run_num=$(ps -ef|grep masterha_manager |grep -v grep|wc -l)
pid_file=&apos;/data/mha/app1/app1.master_status.health&apos;

start() {
   if [[ $run_num &lt; 1 ]];then
   args=&quot;--conf=/data/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover&quot;
   nohup masterha_manager $args &lt; /dev/null &gt; /data/mha/app1/app1.log 2&gt;&amp;1 &amp;
   else
     echo &apos;mha is already running...&apos;
   fi
}

stop() {

  if [[ $run_num &lt; 1 ]];then
     echo &apos;mha not running ...&apos;
     exit 64
  else
     ps -ef|grep masterha_manager |grep -v grep|awk &apos;{print $2}&apos;|xargs kill -9
     rm -f $pid_file
     echo &apos;mha stop...&apos;
  fi
}

status() {
 masterha_check_status --conf=/data/mha/app1.cnf
}

case &quot;$1&quot; in
  start)
  start
  ;;
  stop)
  stop
  ;;
  status)
  status
  ;;
  *)
  echo &apos;mhaCli {stop|start|status}&apos;
  ;;
esac
</code></pre><h2 id="26-&#x4E92;&#x901A;&#x6027;&#x548C;&#x590D;&#x5236;&#x7684;&#x9A8C;&#x8BC1;">2.6 &#x4E92;&#x901A;&#x6027;&#x548C;&#x590D;&#x5236;&#x7684;&#x9A8C;&#x8BC1;</h2>
<h3 id="261-&#x4E92;&#x901A;&#x6027;&#x7684;&#x9A8C;&#x8BC1;">2.6.1 &#x4E92;&#x901A;&#x6027;&#x7684;&#x9A8C;&#x8BC1;</h3>
<p>&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;:</p>
<pre class="language-"><code>shell&gt; masterha_check_ssh --conf=/etc/mha/app1/app1.cnf
</code></pre><p>&#x62A5;&#x9519;:</p>
<pre class="language-"><code>[root@ai2018 .ssh]# masterha_check_ssh --conf=/etc/mha/app1/app1.cnf
Mon Mar 26 22:36:57 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Mon Mar 26 22:36:57 2018 - [info] Reading application default configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 22:36:57 2018 - [info] Reading server configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 22:36:57 2018 - [info] Starting SSH connection tests..
Mon Mar 26 22:36:58 2018 - [debug]
Mon Mar 26 22:36:57 2018 - [debug]  Connecting via SSH from root@192.168.0.175(192.168.0.175:10022) to root@192.168.0.176(192.168.0.176:10022)..
Mon Mar 26 22:36:57 2018 - [debug]   ok.
Mon Mar 26 22:36:57 2018 - [debug]  Connecting via SSH from root@192.168.0.175(192.168.0.175:10022) to root@192.168.0.200(192.168.0.200:10022)..
Mon Mar 26 22:36:58 2018 - [debug]   ok.
Mon Mar 26 22:36:58 2018 - [debug]
Mon Mar 26 22:36:57 2018 - [debug]  Connecting via SSH from root@192.168.0.176(192.168.0.176:10022) to root@192.168.0.175(192.168.0.175:10022)..
Mon Mar 26 22:36:58 2018 - [debug]   ok.
Mon Mar 26 22:36:58 2018 - [debug]  Connecting via SSH from root@192.168.0.176(192.168.0.176:10022) to root@192.168.0.200(192.168.0.200:10022)..
Mon Mar 26 22:36:58 2018 - [debug]   ok.
Mon Mar 26 22:36:58 2018 - [error][/usr/local/share/perl5/MHA/SSHCheck.pm, ln63]
Mon Mar 26 22:36:58 2018 - [debug]  Connecting via SSH from root@192.168.0.200(192.168.0.200:10022) to root@192.168.0.175(192.168.0.175:10022)..
Permission denied (publickey,password,keyboard-interactive).
Mon Mar 26 22:36:58 2018 - [error][/usr/local/share/perl5/MHA/SSHCheck.pm, ln111] SSH connection from root@192.168.0.200(192.168.0.200:10022) to root@192.168.0.175(192.168.0.175:10022) failed!
SSH Configuration Check Failed!
</code></pre><p>&#x6B63;&#x786E;&#x914D;&#x7F6E;&#x540E;,&#x9A8C;&#x8BC1;&#x5E94;&#x8BE5;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code>[root@ai2018 ~]# masterha_check_ssh --conf=/etc/mha/app1/app1.cnf
Mon Mar 26 23:01:32 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Mon Mar 26 23:01:32 2018 - [info] Reading application default configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:01:32 2018 - [info] Reading server configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:01:32 2018 - [info] Starting SSH connection tests..
Mon Mar 26 23:01:33 2018 - [debug]
Mon Mar 26 23:01:32 2018 - [debug]  Connecting via SSH from root@192.168.0.175(192.168.0.175:10022) to root@192.168.0.176(192.168.0.176:10022)..
Mon Mar 26 23:01:33 2018 - [debug]   ok.
Mon Mar 26 23:01:33 2018 - [debug]  Connecting via SSH from root@192.168.0.175(192.168.0.175:10022) to root@192.168.0.200(192.168.0.200:10022)..
Mon Mar 26 23:01:33 2018 - [debug]   ok.
Mon Mar 26 23:01:34 2018 - [debug]
Mon Mar 26 23:01:33 2018 - [debug]  Connecting via SSH from root@192.168.0.176(192.168.0.176:10022) to root@192.168.0.175(192.168.0.175:10022)..
Mon Mar 26 23:01:33 2018 - [debug]   ok.
Mon Mar 26 23:01:33 2018 - [debug]  Connecting via SSH from root@192.168.0.176(192.168.0.176:10022) to root@192.168.0.200(192.168.0.200:10022)..
Mon Mar 26 23:01:33 2018 - [debug]   ok.
Mon Mar 26 23:01:34 2018 - [debug]
Mon Mar 26 23:01:33 2018 - [debug]  Connecting via SSH from root@192.168.0.200(192.168.0.200:10022) to root@192.168.0.175(192.168.0.175:10022)..
Mon Mar 26 23:01:34 2018 - [debug]   ok.
Mon Mar 26 23:01:34 2018 - [debug]  Connecting via SSH from root@192.168.0.200(192.168.0.200:10022) to root@192.168.0.176(192.168.0.176:10022)..
Mon Mar 26 23:01:34 2018 - [debug]   ok.
Mon Mar 26 23:01:34 2018 - [info] All SSH connection tests passed successfully.
</code></pre><h3 id="262-&#x590D;&#x5236;&#x6B63;&#x786E;&#x6027;&#x7684;&#x9A8C;&#x8BC1;">2.6.2 &#x590D;&#x5236;&#x6B63;&#x786E;&#x6027;&#x7684;&#x9A8C;&#x8BC1;</h3>
<p>&#x62A5;&#x9519;1</p>
<pre class="language-"><code>[root@ai2018 app1]# masterha_check_repl --conf=/etc/mha/app1/app1.cnf
Mon Mar 26 22:51:18 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Mon Mar 26 22:51:18 2018 - [info] Reading application default configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 22:51:18 2018 - [info] Reading server configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 22:51:18 2018 - [info] MHA::MasterMonitor version 0.57.
Mon Mar 26 22:51:18 2018 - [info] GTID failover mode = 1
Mon Mar 26 22:51:18 2018 - [info] Dead Servers:
Mon Mar 26 22:51:18 2018 - [info] Alive Servers:
Mon Mar 26 22:51:18 2018 - [info]   192.168.0.175(192.168.0.175:3306)
Mon Mar 26 22:51:18 2018 - [info]   192.168.0.176(192.168.0.176:3306)
Mon Mar 26 22:51:18 2018 - [info]   192.168.0.200(192.168.0.200:3306)
Mon Mar 26 22:51:18 2018 - [info] Alive Slaves:
Mon Mar 26 22:51:18 2018 - [info]   192.168.0.176(192.168.0.176:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 22:51:18 2018 - [info]     GTID ON
Mon Mar 26 22:51:18 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 22:51:18 2018 - [info]   192.168.0.200(192.168.0.200:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 22:51:18 2018 - [info]     GTID ON
Mon Mar 26 22:51:18 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 22:51:18 2018 - [info] Current Alive Master: 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 22:51:18 2018 - [info] Checking slave configurations..
Mon Mar 26 22:51:18 2018 - [info] Checking replication filtering settings..
Mon Mar 26 22:51:18 2018 - [info]  binlog_do_db= , binlog_ignore_db=
Mon Mar 26 22:51:18 2018 - [info]  Replication filtering check ok.
Mon Mar 26 22:51:18 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln427] Error happened on checking configurations. Got MySQL error when checking replication privilege. 29: File &apos;./mysql/user.MYD&apos; not found (Errcode: 2 - No such file or directory) query:SELECT Repl_slave_priv AS Value FROM mysql.user WHERE user = ?
 at /usr/local/share/perl5/MHA/Server.pm line 397
Mon Mar 26 22:51:18 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln525] Error happened on monitoring servers.
Mon Mar 26 22:51:18 2018 - [info] Got exit code 1 (Not master dead).

MySQL Replication Health is NOT OK!
</code></pre><p>&#x68C0;&#x67E5;&#x8FC7;&#x7A0B;</p>
<pre class="language-"><code>mysql&gt; SELECT Repl_slave_priv AS Value FROM mysql.user WHERE user = &apos;repluser&apos;;
ERROR 29 (HY000): File &apos;./mysql/user.MYD&apos; not found (Errcode: 2 - No such file or directory)
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
+--------------------+
1 row in set (0.00 sec)

mysql&gt; exit
</code></pre><p>&#x62A5;&#x9519;2</p>
<pre class="language-"><code>[root@ai2018 ~]# masterha_check_repl  --conf=/etc/mha/app1/app1.cnf
Mon Mar 26 23:01:44 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Mon Mar 26 23:01:44 2018 - [info] Reading application default configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:01:44 2018 - [info] Reading server configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:01:44 2018 - [info] MHA::MasterMonitor version 0.57.
Mon Mar 26 23:01:44 2018 - [info] GTID failover mode = 1
Mon Mar 26 23:01:44 2018 - [info] Dead Servers:
Mon Mar 26 23:01:44 2018 - [info] Alive Servers:
Mon Mar 26 23:01:44 2018 - [info]   192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:01:44 2018 - [info]   192.168.0.176(192.168.0.176:3306)
Mon Mar 26 23:01:44 2018 - [info]   192.168.0.200(192.168.0.200:3306)
Mon Mar 26 23:01:44 2018 - [info] Alive Slaves:
Mon Mar 26 23:01:44 2018 - [info]   192.168.0.176(192.168.0.176:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 23:01:44 2018 - [info]     GTID ON
Mon Mar 26 23:01:44 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:01:44 2018 - [info]   192.168.0.200(192.168.0.200:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 23:01:44 2018 - [info]     GTID ON
Mon Mar 26 23:01:44 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:01:44 2018 - [info] Current Alive Master: 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:01:44 2018 - [info] Checking slave configurations..
Mon Mar 26 23:01:44 2018 - [info]  read_only=1 is not set on slave 192.168.0.200(192.168.0.200:3306).
Mon Mar 26 23:01:44 2018 - [info] Checking replication filtering settings..
Mon Mar 26 23:01:44 2018 - [info]  binlog_do_db= , binlog_ignore_db=
Mon Mar 26 23:01:44 2018 - [info]  Replication filtering check ok.
Mon Mar 26 23:01:44 2018 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
Mon Mar 26 23:01:44 2018 - [info] Checking SSH publickey authentication settings on the current master..
Mon Mar 26 23:01:44 2018 - [info] HealthCheck: SSH to 192.168.0.175 is reachable.
Mon Mar 26 23:01:44 2018 - [info]
192.168.0.175(192.168.0.175:3306) (current master)
 +--192.168.0.176(192.168.0.176:3306)
 +--192.168.0.200(192.168.0.200:3306)

Mon Mar 26 23:01:44 2018 - [info] Checking replication health on 192.168.0.176..
Mon Mar 26 23:01:44 2018 - [info]  ok.
Mon Mar 26 23:01:44 2018 - [info] Checking replication health on 192.168.0.200..
Mon Mar 26 23:01:44 2018 - [info]  ok.
Mon Mar 26 23:01:44 2018 - [info] Checking master_ip_failover_script status:
Mon Mar 26 23:01:44 2018 - [info]   /etc/mha/script/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.0.175 --orig_master_ip=192.168.0.175 --orig_master_port=3306  --orig_master_ssh_port=10022
Mon Mar 26 23:01:44 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln427] Error happened on checking configurations. Can&apos;t exec &quot;/etc/mha/script/master_ip_failover&quot;: Permission denied at /usr/local/share/perl5/MHA/ManagerUtil.pm line 68.
Mon Mar 26 23:01:44 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln525] Error happened on monitoring servers.
Mon Mar 26 23:01:44 2018 - [info] Got exit code 1 (Not master dead).

MySQL Replication Health is NOT OK!
Mon Mar 26 23:01:44 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln229]  Failed to get master_ip_failover_script status with return code 1:0.
Mon Mar 26 23:01:44 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln427] Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line 48
Mon Mar 26 23:01:44 2018 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln525] Error happened on monitoring servers.
Mon Mar 26 23:01:44 2018 - [info] Got exit code 1 (Not master dead).

MySQL Replication Health is NOT OK!
</code></pre><p>&#x6B63;&#x786E;&#x7684;&#x8BBE;&#x7F6E;&#x540E;,&#x9A8C;&#x8BC1;&#x901A;&#x8FC7;&#x5E94;&#x8BE5;&#x5982;&#x4E0B;:</p>
<pre class="language-"><code>[root@ai2018 ~]# masterha_check_repl  --conf=/etc/mha/app1/app1.cnf
Mon Mar 26 23:02:21 2018 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Mon Mar 26 23:02:21 2018 - [info] Reading application default configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:02:21 2018 - [info] Reading server configuration from /etc/mha/app1/app1.cnf..
Mon Mar 26 23:02:21 2018 - [info] MHA::MasterMonitor version 0.57.
Mon Mar 26 23:02:21 2018 - [info] GTID failover mode = 1
Mon Mar 26 23:02:21 2018 - [info] Dead Servers:
Mon Mar 26 23:02:21 2018 - [info] Alive Servers:
Mon Mar 26 23:02:21 2018 - [info]   192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:02:21 2018 - [info]   192.168.0.176(192.168.0.176:3306)
Mon Mar 26 23:02:21 2018 - [info]   192.168.0.200(192.168.0.200:3306)
Mon Mar 26 23:02:21 2018 - [info] Alive Slaves:
Mon Mar 26 23:02:21 2018 - [info]   192.168.0.176(192.168.0.176:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 23:02:21 2018 - [info]     GTID ON
Mon Mar 26 23:02:21 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:02:21 2018 - [info]   192.168.0.200(192.168.0.200:3306)  Version=5.7.21-log (oldest major version between slaves) log-bin:enabled
Mon Mar 26 23:02:21 2018 - [info]     GTID ON
Mon Mar 26 23:02:21 2018 - [info]     Replicating from 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:02:21 2018 - [info] Current Alive Master: 192.168.0.175(192.168.0.175:3306)
Mon Mar 26 23:02:21 2018 - [info] Checking slave configurations..
Mon Mar 26 23:02:21 2018 - [info]  read_only=1 is not set on slave 192.168.0.200(192.168.0.200:3306).
Mon Mar 26 23:02:21 2018 - [info] Checking replication filtering settings..
Mon Mar 26 23:02:21 2018 - [info]  binlog_do_db= , binlog_ignore_db=
Mon Mar 26 23:02:21 2018 - [info]  Replication filtering check ok.
Mon Mar 26 23:02:21 2018 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
Mon Mar 26 23:02:21 2018 - [info] Checking SSH publickey authentication settings on the current master..
Mon Mar 26 23:02:21 2018 - [info] HealthCheck: SSH to 192.168.0.175 is reachable.
Mon Mar 26 23:02:21 2018 - [info]
192.168.0.175(192.168.0.175:3306) (current master)
 +--192.168.0.176(192.168.0.176:3306)
 +--192.168.0.200(192.168.0.200:3306)

Mon Mar 26 23:02:21 2018 - [info] Checking replication health on 192.168.0.176..
Mon Mar 26 23:02:21 2018 - [info]  ok.
Mon Mar 26 23:02:21 2018 - [info] Checking replication health on 192.168.0.200..
Mon Mar 26 23:02:21 2018 - [info]  ok.
Mon Mar 26 23:02:21 2018 - [info] Checking master_ip_failover_script status:
Mon Mar 26 23:02:21 2018 - [info]   /etc/mha/script/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.0.175 --orig_master_ip=192.168.0.175 --orig_master_port=3306  --orig_master_ssh_port=10022
Unknown option: orig_master_ssh_port


IN SCRIPT TEST====/sbin/ifconfig eth2:91 down==/sbin/ifconfig eth2:91 192.168.0.177/24===

Checking the Status of the script.. OK
Mon Mar 26 23:02:21 2018 - [info]  OK.
Mon Mar 26 23:02:21 2018 - [warning] shutdown_script is not defined.
Mon Mar 26 23:02:21 2018 - [info] Got exit code 0 (Not master dead).

MySQL Replication Health is OK.
</code></pre><h2 id="27-&#x542F;&#x52A8;manager&#x8282;&#x70B9;&#xFF1A;">2.7 &#x542F;&#x52A8;manager&#x8282;&#x70B9;&#xFF1A;</h2>
<pre class="language-"><code>shell&gt;  /etc/mha/bin/mhaCli.sh start
</code></pre><p>&#x3000;&#x3000;</p>
<h2 id="28-&#x68C0;&#x67E5;mha-manager&#x7684;&#x72B6;&#x6001;&#xFF1A;">2.8 &#x68C0;&#x67E5;mha manager&#x7684;&#x72B6;&#x6001;&#xFF1A;</h2>
<pre class="language-"><code>shell&gt; masterha_check_status --conf=/etc/mha/app1/app1.cnf
&#x6216;&#x8005;&#xFF1A; /etc/mha/bin/mhaCli.sh status
</code></pre><h2 id="29-&#x914D;&#x7F6E;vip&#x6DFB;&#x52A0;&#x865A;&#x62DF;ip&#x5730;&#x5740;">2.9 &#x914D;&#x7F6E;VIP,&#x6DFB;&#x52A0;&#x865A;&#x62DF;Ip&#x5730;&#x5740;</h2>
<pre class="language-"><code>[root@nazeebo mysql_data]# ifconfig eth2:88 192.168.0.177/24
[root@nazeebo mysql_data]# ip addr
1: lo: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LOOPBACK,UP,LOWER_UP</span><span class="token punctuation">&gt;</span></span> mtu 65536 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth2: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP</span><span class="token punctuation">&gt;</span></span> mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:50:56:a5:b0:38 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.175/24 brd 192.168.0.255 scope global eth2
    inet 192.168.0.177/24 brd 192.168.0.255 scope global secondary eth2:88
    inet6 fe80::250:56ff:fea5:b038/64 scope link
       valid_lft forever preferred_lft forever
[root@nazeebo mysql_data]#
</code></pre><h1 id="3-&#x9A8C;&#x8BC1;&#x5207;&#x6362;&#x9A8C;&#x8BC1;">3. &#x9A8C;&#x8BC1;&#x5207;&#x6362;&#x9A8C;&#x8BC1;</h1>
<p>&#x5C06;master&#x8282;&#x70B9;&#x7684;&#x6570;&#x636E;&#x5E93;&#x505C;&#x6389;,&#x8FC7;&#x4E00;&#x4F1A;&#x513F;&#x770B;vip&#x662F;&#x5426;&#x98D8;&#x79FB;&#x5230;&#x65B0;&#x7684;master&#x7684;ethx&#x4E0A;</p>
<h1 id="4&#x8282;&#x70B9;&#x91CD;&#x65B0;&#x4E0A;&#x4E0B;&#x6B65;&#x9AA4;">4.&#x8282;&#x70B9;&#x91CD;&#x65B0;&#x4E0A;&#x4E0B;&#x6B65;&#x9AA4;</h1>
<p>&#x5F53;&#x51FA;&#x95EE;&#x9898;&#x7684;&#x539F;master&#x670D;&#x52A1;&#x5668;175&#x95EE;&#x9898;&#x4FEE;&#x590D;&#x597D;&#x540E;&#xFF0C;&#x6B64;&#x65F6;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x4E0A;&#x7EBF;&#x4E3B;&#x673A;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ol>
<li>&#x5728;&#x670D;&#x52A1;&#x5668;175&#x4E0A;&#x642D;&#x5EFA;&#x597D;mysql&#x670D;&#x52A1;&#xFF0C;&#x5EFA;&#x8BAE;&#x548C;&#x4E4B;&#x524D;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x4E00;&#x81F4;&#xFF1B;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x514D;&#x5BC6;&#x3002;</li>
<li>&#x5728;&#x73B0;&#x5728;&#x7684;master&#x6216;&#x8005;slave&#x4F7F;&#x7528;mysqldump&#x5C06;&#x6570;&#x636E;&#x5907;&#x4EFD;&#xFF0C;&#x52A0;--master-data=2 -A&#x53C2;&#x6570;</li>
<li>&#x5C06;&#x5907;&#x4EFD;&#x6570;&#x6765;&#x7684;&#x6570;&#x636E;&#x5728;&#x670D;&#x52A1;&#x5668;175&#x4E0A;&#x8FDB;&#x884C;&#x6062;&#x590D;&#xFF0C;&#x5B8C;&#x6210;&#x540E;&#x6267;&#x884C;flush privileges&#x5237;&#x65B0;&#x6743;&#x9650;&#x3002;</li>
<li>&#x6210;&#x540E;&#x914D;&#x7F6E;GTID&#x7684;change master&#x64CD;&#x4F5C;&#xFF0C;start slave&#x5373;&#x53EF;</li>
<li>&#x5C06;&#x4E3B;&#x673A;&#x7684;&#x4FE1;&#x606F;&#x6DFB;&#x52A0;&#x5230;mha&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x4EE5;&#x4FBF;mha manager&#x68C0;&#x6D4B;&#x5230;&#x65B0;&#x7684;&#x8282;&#x70B9;&#x4E3B;&#x673A;</li>
<li>&#x4F7F;&#x7528;mha&#x7684;&#x6D4B;&#x8BD5;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#xFF0C;&#x6210;&#x529F;&#x5219;&#x542F;&#x52A8;mha&#x7A0B;&#x5E8F;&#x5373;&#x53EF;</li>
</ol>
<h1 id="5&#x5176;&#x4ED6;">5.&#x5176;&#x4ED6;</h1>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; suredandan 2018 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">UpdateTime: 
2018-11-28 06:47:39
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="f_mysqlcheck.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 附录6-mysqlcheck的使用">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"附录7-mha配置.md","level":"1.24.7","depth":2,"previous":{"title":"附录6-mysqlcheck的使用","level":"1.24.6","depth":2,"path":"f_mysqlcheck.md","ref":"f_mysqlcheck.md","articles":[]},"dir":"ltr"},"config":{"plugins":["prism","prism-themes","-highlight","codesnippet","splitter","simple-page-toc","page-toc-button","back-to-top-button","-lunr","-search","search-plus","favicon@^0.0.2","tbfed-pagefooter@^0.0.1","theme-default","sitemap-general"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright © suredandan 2018","modify_label":"UpdateTime: ","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prismjs/themes/prism-solarizedlight.css"]},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"splitter":{},"codesnippet":{},"sitemap-general":{"prefix":"http://www.googlebaba.io/mysql/"},"fontsettings":{"theme":"white","family":"sans","size":2},"favicon":{"shortcut":"favicon.ico","bookmark":"favicon.ico"},"page-toc-button":{},"back-to-top-button":{},"prism-themes":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"showLevel":true,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"search-plus":{},"image-captions":{"caption":"_CAPTION_"}},"theme":"default","author":"suredandan","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"MySQL搬砖","language":"zh-hans","gitbook":"*","description":"MySQL进阶指南"},"file":{"path":"f_mha.md","mtime":"2018-11-27T22:47:39.779Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-06-10T13:30:33.979Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

